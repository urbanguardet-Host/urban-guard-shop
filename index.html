<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Urban Guard | Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <style>
    body { font-family: Inter, system-ui, sans-serif; }
    .hidden { display: none !important; }
    .tab-active { border-left: 4px solid #3b82f6; background:#1e293b; color:white }
  </style>
</head>

<body class="bg-gray-100 min-h-screen">

<!-- LOGIN / RESET -->
<div id="login-screen" class="fixed inset-0 bg-slate-900 z-50 hidden flex items-center justify-center">
  <div class="bg-white p-8 rounded-3xl w-full max-w-md text-center shadow-xl">
    <h1 class="text-2xl font-black mb-2">Urban Guard Admin</h1>
    <p class="text-slate-400 text-sm mb-6">Secure Hardware Management</p>

    <form id="loginForm" class="space-y-4">
      <input id="loginEmail" type="email" placeholder="Email" required class="w-full p-3 border rounded-xl">
      <input id="loginPass" type="password" placeholder="Password" required class="w-full p-3 border rounded-xl">
      <button class="w-full py-3 bg-blue-600 text-white rounded-xl font-bold">SIGN IN</button>
    </form>

    <button onclick="sendResetEmail()" class="mt-4 text-xs font-bold text-slate-400 uppercase">
      Forgot password?
    </button>

    <div id="reset-box" class="hidden mt-6 border-t pt-4">
      <p class="text-xs font-bold text-blue-600 uppercase mb-2">Reset Password</p>
      <input id="newPass" type="password" placeholder="New password" class="w-full p-3 border rounded-xl mb-2">
      <button onclick="updatePassword()" class="w-full py-3 bg-green-600 text-white rounded-xl font-bold">
        Save New Password
      </button>
    </div>
  </div>
</div>

<!-- ADMIN -->
<aside id="admin-sidebar" class="hidden fixed w-72 h-full bg-slate-900 text-white">
  <div class="p-5 border-b flex justify-between">
    <span class="font-black text-blue-400">ADMIN</span>
    <button onclick="logout()"><i class="fas fa-power-off"></i></button>
  </div>
</aside>

<main id="main-content" class="hidden ml-72 p-8">
  <h2 class="font-black text-xl">Dashboard</h2>
  <p class="text-slate-500">You are logged in.</p>
</main>

<script>
/* ---------------- CONFIG ---------------- */
const supabase = window.supabase.createClient(
  "https://oojkvzgsamewgibmwhpu.supabase.co",
  "YOUR_ANON_KEY"
);

/* --------------- BOOTSTRAP --------------- */
const loginScreen = document.getElementById('login-screen');
const resetBox    = document.getElementById('reset-box');
const loginForm   = document.getElementById('loginForm');
const sidebar     = document.getElementById('admin-sidebar');
const main        = document.getElementById('main-content');

/* Hide everything immediately */
loginScreen.classList.add('hidden');
sidebar.classList.add('hidden');
main.classList.add('hidden');

/* Handle recovery BEFORE auth logic */
const isRecovery = window.location.hash.includes('type=recovery');
if (isRecovery) {
  loginScreen.classList.remove('hidden');
  loginForm.classList.add('hidden');
  resetBox.classList.remove('hidden');
}

/* Initial auth check (CRITICAL) */
(async function initAuth() {
  const { data: { session } } = await supabase.auth.getSession();

  if (session && !isRecovery) {
    showAdmin();
  } else if (!isRecovery) {
    showLogin();
  }
})();

/* Auth listener (NO redirects here) */
supabase.auth.onAuthStateChange((event, session) => {
  if (event === 'SIGNED_IN') showAdmin();
  if (event === 'SIGNED_OUT') showLogin();
});

/* ---------------- UI ---------------- */
function showLogin() {
  loginScreen.classList.remove('hidden');
  sidebar.classList.add('hidden');
  main.classList.add('hidden');
}

function showAdmin() {
  loginScreen.classList.add('hidden');
  sidebar.classList.remove('hidden');
  main.classList.remove('hidden');
}

/* --------------- AUTH ---------------- */
loginForm.addEventListener('submit', async e => {
  e.preventDefault();
  const email = loginEmail.value;
  const password = loginPass.value;

  const { error } = await supabase.auth.signInWithPassword({ email, password });
  if (error) alert(error.message);
});

async function sendResetEmail() {
  if (!loginEmail.value) return alert("Enter email first");
  await supabase.auth.resetPasswordForEmail(loginEmail.value, {
    redirectTo: window.location.href
  });
  alert("Reset email sent");
}

async function updatePassword() {
  const { error } = await supabase.auth.updateUser({ password: newPass.value });
  if (error) return alert(error.message);
  window.location.hash = '';
  location.reload();
}

async function logout() {
  await supabase.auth.signOut();
}
</script>
</body>
</html>
